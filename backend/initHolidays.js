const sqlite3 = require('sqlite3').verbose();
const path = require('path');

// DB íŒŒì¼ ê²½ë¡œ
const dbPath = path.join(__dirname, 'database', 'database.sqlite');

// DB ì—°ê²°
const db = new sqlite3.Database(dbPath);

console.log('ğŸ‰ ê³µíœ´ì¼ ë°ì´í„° ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');

// holidays í…Œì´ë¸” ìƒì„±
const createTableSQL = `
CREATE TABLE IF NOT EXISTS holidays (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL,
  name TEXT NOT NULL,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  day INTEGER NOT NULL,
  is_recurring INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
`;

// ì¸ë±ìŠ¤ ìƒì„±
const createIndexSQL = `
CREATE INDEX IF NOT EXISTS idx_holidays_date ON holidays(date);
CREATE INDEX IF NOT EXISTS idx_holidays_year ON holidays(year);
`;

// ê³µíœ´ì¼ ë°ì´í„°
const holidaysData = [
  // 2024ë…„
  ['2024-01-01', 'ì‹ ì •', 2024, 1, 1, 1],
  ['2024-02-09', 'ì„¤ë‚ ', 2024, 2, 9, 0],
  ['2024-02-10', 'ì„¤ë‚ ', 2024, 2, 10, 0],
  ['2024-02-11', 'ì„¤ë‚ ', 2024, 2, 11, 0],
  ['2024-03-01', 'ì‚¼ì¼ì ˆ', 2024, 3, 1, 1],
  ['2024-04-10', 'ì œ22ëŒ€ êµ­íšŒì˜ì›ì„ ê±°', 2024, 4, 10, 0],
  ['2024-05-05', 'ì–´ë¦°ì´ë‚ ', 2024, 5, 5, 1],
  ['2024-05-15', 'ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ ', 2024, 5, 15, 0],
  ['2024-06-06', 'í˜„ì¶©ì¼', 2024, 6, 6, 1],
  ['2024-08-15', 'ê´‘ë³µì ˆ', 2024, 8, 15, 1],
  ['2024-09-16', 'ì¶”ì„', 2024, 9, 16, 0],
  ['2024-09-17', 'ì¶”ì„', 2024, 9, 17, 0],
  ['2024-09-18', 'ì¶”ì„', 2024, 9, 18, 0],
  ['2024-10-03', 'ê°œì²œì ˆ', 2024, 10, 3, 1],
  ['2024-10-09', 'í•œê¸€ë‚ ', 2024, 10, 9, 1],
  ['2024-12-25', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 2024, 12, 25, 1],

  // 2025ë…„
  ['2025-01-01', 'ì‹ ì •', 2025, 1, 1, 1],
  ['2025-01-28', 'ì„¤ë‚ ', 2025, 1, 28, 0],
  ['2025-01-29', 'ì„¤ë‚ ', 2025, 1, 29, 0],
  ['2025-01-30', 'ì„¤ë‚ ', 2025, 1, 30, 0],
  ['2025-03-01', 'ì‚¼ì¼ì ˆ', 2025, 3, 1, 1],
  ['2025-05-05', 'ì–´ë¦°ì´ë‚ ', 2025, 5, 5, 1],
  ['2025-05-06', 'ì–´ë¦°ì´ë‚  ëŒ€ì²´ê³µíœ´ì¼', 2025, 5, 6, 0],
  ['2025-05-15', 'ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ ', 2025, 5, 15, 0],
  ['2025-06-06', 'í˜„ì¶©ì¼', 2025, 6, 6, 1],
  ['2025-08-15', 'ê´‘ë³µì ˆ', 2025, 8, 15, 1],
  ['2025-10-03', 'ê°œì²œì ˆ', 2025, 10, 3, 1],
  ['2025-10-06', 'ì¶”ì„', 2025, 10, 6, 0],
  ['2025-10-07', 'ì¶”ì„', 2025, 10, 7, 0],
  ['2025-10-08', 'ì¶”ì„', 2025, 10, 8, 0],
  ['2025-10-09', 'í•œê¸€ë‚ ', 2025, 10, 9, 1],
  ['2025-12-25', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 2025, 12, 25, 1],

  // 2026ë…„
  ['2026-01-01', 'ì‹ ì •', 2026, 1, 1, 1],
  ['2026-02-16', 'ì„¤ë‚ ', 2026, 2, 16, 0],
  ['2026-02-17', 'ì„¤ë‚ ', 2026, 2, 17, 0],
  ['2026-02-18', 'ì„¤ë‚ ', 2026, 2, 18, 0],
  ['2026-03-01', 'ì‚¼ì¼ì ˆ', 2026, 3, 1, 1],
  ['2026-05-05', 'ì–´ë¦°ì´ë‚ ', 2026, 5, 5, 1],
  ['2026-05-24', 'ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ ', 2026, 5, 24, 0],
  ['2026-06-06', 'í˜„ì¶©ì¼', 2026, 6, 6, 1],
  ['2026-08-15', 'ê´‘ë³µì ˆ', 2026, 8, 15, 1],
  ['2026-09-24', 'ì¶”ì„', 2026, 9, 24, 0],
  ['2026-09-25', 'ì¶”ì„', 2026, 9, 25, 0],
  ['2026-09-26', 'ì¶”ì„', 2026, 9, 26, 0],
  ['2026-10-03', 'ê°œì²œì ˆ', 2026, 10, 3, 1],
  ['2026-10-09', 'í•œê¸€ë‚ ', 2026, 10, 9, 1],
  ['2026-12-25', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 2026, 12, 25, 1],

  // 2027ë…„ (ë§¤ë…„ ë°˜ë³µë˜ëŠ” ê³µíœ´ì¼ë§Œ)
  ['2027-01-01', 'ì‹ ì •', 2027, 1, 1, 1],
  ['2027-03-01', 'ì‚¼ì¼ì ˆ', 2027, 3, 1, 1],
  ['2027-05-05', 'ì–´ë¦°ì´ë‚ ', 2027, 5, 5, 1],
  ['2027-06-06', 'í˜„ì¶©ì¼', 2027, 6, 6, 1],
  ['2027-08-15', 'ê´‘ë³µì ˆ', 2027, 8, 15, 1],
  ['2027-10-03', 'ê°œì²œì ˆ', 2027, 10, 3, 1],
  ['2027-10-09', 'í•œê¸€ë‚ ', 2027, 10, 9, 1],
  ['2027-12-25', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 2027, 12, 25, 1],

  // 2028ë…„ (ë§¤ë…„ ë°˜ë³µë˜ëŠ” ê³µíœ´ì¼ë§Œ)
  ['2028-01-01', 'ì‹ ì •', 2028, 1, 1, 1],
  ['2028-03-01', 'ì‚¼ì¼ì ˆ', 2028, 3, 1, 1],
  ['2028-05-05', 'ì–´ë¦°ì´ë‚ ', 2028, 5, 5, 1],
  ['2028-06-06', 'í˜„ì¶©ì¼', 2028, 6, 6, 1],
  ['2028-08-15', 'ê´‘ë³µì ˆ', 2028, 8, 15, 1],
  ['2028-10-03', 'ê°œì²œì ˆ', 2028, 10, 3, 1],
  ['2028-10-09', 'í•œê¸€ë‚ ', 2028, 10, 9, 1],
  ['2028-12-25', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 2028, 12, 25, 1]
];

// ë°ì´í„° ì‚½ì… SQL
const insertSQL = `
INSERT OR IGNORE INTO holidays (date, name, year, month, day, is_recurring)
VALUES (?, ?, ?, ?, ?, ?)
`;

// ì‹¤í–‰ í•¨ìˆ˜
async function initHolidays() {
  return new Promise((resolve, reject) => {
    db.serialize(() => {
      // í…Œì´ë¸” ìƒì„±
      db.run(createTableSQL, (err) => {
        if (err) {
          console.error('âŒ í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨:', err.message);
          reject(err);
          return;
        }
        console.log('âœ… holidays í…Œì´ë¸” ìƒì„± ì™„ë£Œ');

        // ì¸ë±ìŠ¤ ìƒì„±
        db.run(createIndexSQL, (err) => {
          if (err) {
            console.error('âŒ ì¸ë±ìŠ¤ ìƒì„± ì‹¤íŒ¨:', err.message);
            reject(err);
            return;
          }
          console.log('âœ… ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ');

          // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
          db.run('DELETE FROM holidays', (err) => {
            if (err) {
              console.error('âŒ ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', err.message);
              reject(err);
              return;
            }
            console.log('âœ… ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');

            // ìƒˆ ë°ì´í„° ì‚½ì…
            const stmt = db.prepare(insertSQL);
            let insertedCount = 0;

            holidaysData.forEach((holiday, index) => {
              stmt.run(holiday, function(err) {
                if (err) {
                  console.error(`âŒ ë°ì´í„° ì‚½ì… ì‹¤íŒ¨ (${index + 1}ë²ˆì§¸):`, err.message);
                } else {
                  insertedCount++;
                }

                // ë§ˆì§€ë§‰ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ í›„
                if (index === holidaysData.length - 1) {
                  stmt.finalize((err) => {
                    if (err) {
                      console.error('âŒ statement ì •ë¦¬ ì‹¤íŒ¨:', err.message);
                      reject(err);
                      return;
                    }
                    console.log(`âœ… ê³µíœ´ì¼ ë°ì´í„° ì‚½ì… ì™„ë£Œ: ${insertedCount}ê±´`);
                    resolve();
                  });
                }
              });
            });
          });
        });
      });
    });
  });
}

// ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
initHolidays()
  .then(() => {
    console.log('ğŸ‰ ê³µíœ´ì¼ ë°ì´í„° ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    db.close();
  })
  .catch((err) => {
    console.error('âŒ ê³µíœ´ì¼ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', err.message);
    db.close();
    process.exit(1);
  }); 