// controllers/approvalController.js
// ÏäπÏù∏/Î∞òÎ†§ Ï≤òÎ¶¨, ÏäπÏù∏ Ïù¥Î†•, ÎåÄÍ∏∞ Î™©Î°ù Îì± Ï†ÑÏûêÍ≤∞Ïû¨ Ï≤òÎ¶¨
const { logSystemAction } = require("../utils/handleError");
const { LOG_ACTIONS } = require("../utils/logActions");
const { dbGet, dbAll, dbRun } = require("../utils/dbHelpers");

// 1. ÏäπÏù∏ Ï≤òÎ¶¨
exports.approve = async (req, res) => {
  const { targetType, targetId } = req.params;
  const userId = req.user.id;

  console.log("üü¢ ÏäπÏù∏ ÏöîÏ≤≠ ÏãúÏûë:", { userId, targetType, targetId });

  try {
    const row = await dbGet(
      `SELECT id, status, is_final, step
       FROM approvals
       WHERE LOWER(target_type) = LOWER(?) AND target_id = ? AND approver_id = ?`,
      [targetType, targetId, userId]
    );

    if (!row) {
      logSystemAction(
        req,
        req.user,
        LOG_ACTIONS.APPROVE_FAIL,
        `ÏäπÏù∏ Í∂åÌïú ÏóÜÏùå`
      );
      return res.status(403).json({ error: "ÏäπÏù∏ Í∂åÌïú ÏóÜÏùå" });
    }

    if (row.status !== "PENDING") {
      logSystemAction(
        req,
        req.user,
        LOG_ACTIONS.APPROVE_FAIL,
        `Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê® (${row.status})`
      );
      return res.status(400).json({ error: `Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê® (${row.status})` });
    }

    const currentStep = row.step;
    const approvalId = row.id;

    const minPendingStepRow = await dbGet(
      `SELECT MIN(step) as minStep FROM approvals
       WHERE target_type = ? AND target_id = ? AND status = 'PENDING'`,
      [targetType, targetId]
    );

    if (currentStep > minPendingStepRow.minStep) {
      logSystemAction(
        req,
        req.user,
        LOG_ACTIONS.APPROVE_FAIL,
        `Ïù¥Ï†Ñ Îã®Í≥Ñ Í≤∞Ïû¨ ÎØ∏ÏôÑÎ£å (ÌòÑÏû¨ step=${currentStep}, ÏµúÏÜå step=${minPendingStepRow.minStep})`
      );
      return res
        .status(400)
        .json({ error: "Ïù¥Ï†Ñ Îã®Í≥Ñ Í≤∞Ïû¨Í∞Ä ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§." });
    }

    await dbRun(
      `UPDATE approvals SET status = 'APPROVED', approved_at = datetime('now') WHERE id = ?`,
      [approvalId]
    );
    console.log("‚úÖ approvals ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å:", approvalId);

    await dbRun(
      `INSERT INTO approval_history
       (approval_id, target_type, target_id, step, action, memo, actor_id, prev_status, new_status)
       VALUES (?, ?, ?, ?, 'APPROVE', '', ?, 'PENDING', 'APPROVED')`,
      [approvalId, targetType, targetId, currentStep, userId]
    );

    if (row.is_final === 1 && targetType.toLowerCase() === "vacation") {
      const vacationRow = await dbGet(
        `SELECT status, user_id FROM vacations WHERE id = ?`,
        [targetId]
      );

      if (vacationRow) {
        await dbRun(
          `UPDATE vacations
           SET status = 'APPROVED', approved_by = ?, approved_at = datetime('now')
           WHERE id = ?`,
          [userId, targetId]
        );

        await dbRun(
          `INSERT INTO vacation_history
           (vacation_id, user_id, action, old_value, new_value, memo, admin_id)
           VALUES (?, ?, 'APPROVE', ?, 'APPROVED', 'ÏµúÏ¢Ö ÏäπÏù∏', ?)`,
          [targetId, vacationRow.user_id, vacationRow.status, userId]
        );

        console.log("‚úÖ ÏµúÏ¢Ö ÏäπÏù∏ ‚Üí vacations ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å");
      } else {
        console.warn("‚ùó vacation Î†àÏΩîÎìú ÏóÜÏùå");
        logSystemAction(
          req,
          req.user,
          LOG_ACTIONS.APPROVE_FAIL,
          "Ìú¥Í∞Ä Ï†ïÎ≥¥ ÏóÜÏùå"
        );
      }
    } else {
      console.log("‚ÑπÔ∏è ÏµúÏ¢Ö ÏäπÏù∏ ÏïÑÎãò ‚Üí vacation ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏÉùÎûµ");
    }

    logSystemAction(
      req,
      req.user,
      LOG_ACTIONS.APPROVE,
      `${targetType} ${targetId} ÏäπÏù∏`
    );

    res.json({ success: true });
  } catch (err) {
    console.error("‚ùå ÏäπÏù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:", err);
    logSystemAction(
      req,
      req.user,
      LOG_ACTIONS.APPROVE_FAIL,
      `ÏäπÏù∏ Ï≤òÎ¶¨ Ï§ë ÏòàÏô∏ Î∞úÏÉù: ${err.message}`
    );
    res.status(500).json({ error: "ÏäπÏù∏ Ïã§Ìå®" });
  }
};

// 2. Î∞òÎ†§ Ï≤òÎ¶¨
exports.reject = async (req, res) => {
  const { targetType, targetId } = req.params;
  const userId = req.user.id;
  const { memo = "Î∞òÎ†§ Ï≤òÎ¶¨" } = req.body;

  try {
    const row = await dbGet(
      `SELECT status FROM approvals WHERE target_type = ? AND target_id = ? AND approver_id = ?`,
      [targetType, targetId, userId]
    );

    if (!row) {
      logSystemAction(req, req.user, LOG_ACTIONS.REJECT_FAIL, "Î∞òÎ†§ Í∂åÌïú ÏóÜÏùå");
      return res.status(403).json({ error: "Î∞òÎ†§ Í∂åÌïú ÏóÜÏùå" });
    }
    if (row.status !== "PENDING") {
      logSystemAction(
        req,
        req.user,
        LOG_ACTIONS.REJECT_FAIL,
        `Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê® (${row.status})`
      );
      return res.status(400).json({ error: `Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê® (${row.status})` });
    }

    await dbRun(
      `UPDATE approvals SET status = 'REJECTED', memo = ?, approved_at = datetime('now') WHERE target_type = ? AND target_id = ? AND approver_id = ?`,
      [memo, targetType, targetId, userId]
    );

    let updateTargetSql = null;
    if (targetType === "vacation")
      updateTargetSql = `UPDATE vacations SET status = 'REJECTED' WHERE id = ?`;
    if (targetType === "kpi")
      updateTargetSql = `UPDATE kpis SET status = 'REJECTED' WHERE id = ?`;
    if (updateTargetSql) await dbRun(updateTargetSql, [targetId]);

    logSystemAction(
      req,
      req.user,
      LOG_ACTIONS.REJECT,
      `${targetType} ${targetId} Î∞òÎ†§`
    );
    res.json({ success: true });
  } catch (err) {
    console.error("‚ùå Î∞òÎ†§ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:", err);
    logSystemAction(
      req,
      req.user,
      LOG_ACTIONS.REJECT_FAIL,
      `Î∞òÎ†§ Ï≤òÎ¶¨ Ï§ë ÏòàÏô∏ Î∞úÏÉù: ${err.message}`
    );
    res.status(500).json({ error: "Î∞òÎ†§ Ïã§Ìå®" });
  }
};

// 4. ÏäπÏù∏ Ïù¥Î†• Ï°∞Ìöå
exports.getApprovalHistory = async (req, res) => {
  const { targetType, targetId } = req.params;
  try {
    const rows = await dbAll(
      `SELECT a.*, u.name AS approver_name FROM approvals a JOIN users u ON a.approver_id = u.id WHERE target_type = ? AND target_id = ? ORDER BY step ASC, approved_at ASC`,
      [targetType, targetId]
    );
    res.json(rows);
  } catch (err) {
    console.error("‚ùå Ïù¥Î†• Ï°∞Ìöå Ïã§Ìå®:", err);
    res.status(500).json({ error: "Ïù¥Î†• Ï°∞Ìöå Ïã§Ìå®" });
  }
};

// 5. ÎÇ¥Í∞Ä ÏöîÏ≤≠Ìïú ÏäπÏù∏ Î™©Î°ù Ï°∞Ìöå
exports.getRequestedApprovals = async (req, res) => {
  const userId = req.user.id;
  const { target_type } = req.query;

  let sql = `
    SELECT
      a.id, a.target_type, a.target_id, a.created_at, a.due_date,
      u.name AS requester_name
    FROM approvals a
    JOIN users u ON a.requester_id = u.id
    WHERE a.requester_id = ?
  `;
  const params = [userId];

  if (target_type) {
    sql += ` AND target_type = ?`;
    params.push(target_type);
  }
  sql += ` ORDER BY a.created_at DESC`;

  try {
    const rows = await dbAll(sql, params);
    const enrichedRows = await Promise.all(
      rows.map(async (row) => {
        let data = null;
        if ((row.target_type || "").toLowerCase() === "vacation") {
          data = await dbGet(
            `SELECT start_date, end_date, type_code AS type_label FROM vacations WHERE id = ?`,
            [row.target_id]
          );
        } else if ((row.target_type || "").toLowerCase() === "kpi") {
          data = await dbGet(
            `SELECT goal_title, period FROM kpis WHERE id = ?`,
            [row.target_id]
          );
        }
        return {
          id: row.id,
          targetType: (row.target_type || "").toUpperCase(),
          targetId: row.target_id,
          requesterName: row.requester_name,
          createdAt: row.created_at,
          dueDate: row.due_date,
          data,
        };
      })
    );
    res.json(enrichedRows);
  } catch (err) {
    console.error("‚ùå ÎÇ¥Í∞Ä ÏöîÏ≤≠Ìïú ÏäπÏù∏ Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:", err);
    res.status(500).json({ error: "Ï°∞Ìöå Ïã§Ìå®" });
  }
};

// 6. ÎÇ¥Í∞Ä ÏäπÏù∏Ìï† Ìï≠Î™© Î™©Î°ù Ï°∞Ìöå
exports.getPendingToMe = async (req, res) => {
  const userId = req.user.id;
  const { target_type } = req.query;

  let sql = `
    SELECT a.*, u.name AS requester_name
    FROM approvals a
    JOIN users u ON a.requester_id = u.id
    WHERE a.approver_id = ? AND a.status = 'PENDING'
  `;
  const params = [userId];

  if (target_type) {
    sql += ` AND LOWER(target_type) = ?`;
    params.push(target_type.toLowerCase());
  }
  sql += ` ORDER BY created_at ASC`;

  try {
    const rows = await dbAll(sql, params);
    const enriched = await Promise.all(
      rows.map(async (row) => {
        let data = null;
        if (row.target_type === "vacation") {
          data = await dbGet(
            `SELECT start_date, end_date, type_code AS type_label FROM vacations WHERE id = ?`,
            [row.target_id]
          );
        } else if (row.target_type === "kpi") {
          data = await dbGet(
            `SELECT goal_title, period FROM kpis WHERE id = ?`,
            [row.target_id]
          );
        }
        return {
          id: row.id,
          targetType: row.target_type.toUpperCase(),
          targetId: row.target_id,
          requesterName: row.requester_name,
          createdAt: row.created_at,
          dueDate: row.due_date,
          data,
        };
      })
    );
    res.json(enriched);
  } catch (err) {
    console.error("‚ùå ÏäπÏù∏ Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:", err);
    res.status(500).json({ error: "Ï°∞Ìöå Ïã§Ìå®" });
  }
};

// 7. Í≤∞Ïû¨Ïûê ÏßÅÍ∏â Ï†ïÎ≥¥ Ï°∞Ìöå
exports.getPositionLabel = async (req, res) => {
  const targetId = req.params.targetId;
  try {
    const row = await dbGet(
      `SELECT dept.label AS department_label, pos.label AS position_label
       FROM approvals a
       JOIN users u ON a.approver_id = u.id
       LEFT JOIN common_codes dept ON u.department_code = dept.code
       LEFT JOIN common_codes pos ON u.position_code = pos.code
       WHERE a.target_id = ?
       LIMIT 1`,
      [targetId]
    );

    if (!row) {
      logSystemAction(req, req.user, LOG_ACTIONS.READ_FAIL, "Í≤∞Ïû¨Ïûê Ï†ïÎ≥¥ ÏóÜÏùå");
      return res.status(404).json({ error: "Í≤∞Ïû¨Ïûê Ï†ïÎ≥¥ ÏóÜÏùå" });
    }

    const positionLabel = row.position_label || "(ÏßÅÍ∏â ÏóÜÏùå)";
    const departmentLabel = row.department_label || "(Î∂ÄÏÑú ÏóÜÏùå)";
    const combinedLabel = `${departmentLabel} ${positionLabel}`;

    res.json({
      department_label: departmentLabel,
      position_label: positionLabel,
      full_label: combinedLabel,
    });
  } catch (err) {
    console.error("‚ùå ÏäπÏù∏Ïûê Î∂ÄÏÑú/ÏßÅÍ∏â Ï°∞Ìöå Ïã§Ìå®:", err);
    res.status(500).json({ error: "Í≤∞Ïû¨Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®" });
  }
};
// 8. ÏÉÅÏÑ∏ Î≥¥Í∏∞ API
exports.getApprovalDetail = async (req, res) => {
  const { targetType, targetId } = req.params;
  try {
    let data = null;

    if (targetType === "vacation") {
      // Ìú¥Í∞Ä ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå (snapshot Í∞í Ìè¨Ìï®)
      data = await dbGet(
        `SELECT v.start_date, v.end_date, v.type_code, v.reason, v.note, v.created_at,
                v.snapshot_name, v.snapshot_department_code, v.snapshot_position_code, u.employee_number
         FROM vacations v
         LEFT JOIN users u ON v.user_id = u.id
         WHERE v.id = ?`,
        [targetId]
      );

      if (data) {
        // ÏäπÏù∏Ïûê Î™©Î°ù Ï°∞Ìöå (ÏäπÏù∏ ÌÖåÏù¥Î∏î + ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ + ÏßÅÏ±Ö ÎùºÎ≤®)
        const approverRows = await dbAll(
          `SELECT a.step, u.name, u.position_code, cc.label AS position_label
           FROM approvals a
           JOIN users u ON a.approver_id = u.id
           LEFT JOIN common_codes cc ON cc.code_group = 'POSITION' AND cc.code = u.position_code
           WHERE a.target_type = 'vacation' AND a.target_id = ?
           ORDER BY a.step ASC`,
          [targetId]
        );

        // approvers Íµ¨Ï°∞ ÏÉùÏÑ±: ÏßÅÏ±ÖÏóê Îî∞Îùº Ïó≠Ìï† ÌïÑÎìú ÏßÄÏ†ï
        const approvers = {};
        for (const row of approverRows) {
          switch (row.position_code) {
            case "DEPHEAD": // ÌååÌä∏Ïû•
              approvers.partLead = `${row.position_label} ${row.name}`;
              break;
            case "LEAD": // ÌåÄÏû•
              approvers.teamLead = `${row.position_label} ${row.name}`;
              break;
            case "DIR": // Î∂ÄÏû•
            case "EVP": // ÏÉÅÎ¨¥
              approvers.deptHead = `${row.position_label} ${row.name}`;
              break;
            case "CEO": // ÎåÄÌëú
              approvers.ceo = `${row.position_label} ${row.name}`;
              break;
            default:
              // Í∑∏ Ïô∏ ÏßÅÏ±ÖÏùÄ managerÎ°ú Í∞ÑÏ£º (ÏµúÏ¥à 1ÌöåÎßå Ìï†Îãπ)
              if (!approvers.manager) {
                approvers.manager = `${row.position_label} ${row.name}`;
              }
          }
        }

        // Îç∞Ïù¥ÌÑ∞Ïóê approvers ÌïÑÎìú Ìè¨Ìï®
        data.approvers = approvers;
      }
    } else if (targetType === "kpi") {
      // KPI Î¨∏ÏÑú ÏÉÅÏÑ∏
      data = await dbGet(`SELECT goal_title, period FROM kpis WHERE id = ?`, [
        targetId,
      ]);
    }

    // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ 404 Î∞òÌôò
    if (!data) {
      logSystemAction(req, req.user, LOG_ACTIONS.READ_FAIL, "ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå");
      return res.status(404).json({ error: "ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå" });
    }

    // ÏµúÏ¢Ö ÏùëÎãµ
    res.json({
      id: Number(targetId),
      targetType,
      targetId: Number(targetId),
      data,
    });
  } catch (err) {
    console.error("‚ùå ÏÉÅÏÑ∏ Ï°∞Ìöå Ïã§Ìå®:", err);
    res.status(500).json({ error: "ÏÉÅÏÑ∏ Ï°∞Ìöå Ïã§Ìå®" });
  }
};
